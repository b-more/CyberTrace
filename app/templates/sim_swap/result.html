{% extends "base.html" %}
{% block title %}SIM Swap Detection Results{% endblock %}
{% block page_title %}SIM Swap Detection Results{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-danger text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-sim"></i> {{ investigation.target_identifier }}</h5>
            <span class="badge bg-{{ 'success' if investigation.status == 'completed' else 'danger' }}">{{ investigation.status|title }}</span>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Case:</strong> {{ investigation.case.case_number }}</p>
                <p><strong>Investigator:</strong> {{ investigation.investigator.full_name }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Date:</strong> {{ investigation.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                <p><strong>Duration:</strong> {{ investigation.execution_time|round(2) if investigation.execution_time else 'N/A' }}s</p>
            </div>
        </div>
    </div>
</div>

<!-- Risk Assessment -->
<div class="card shadow mb-4">
    <div class="card-header bg-{{ 'danger' if results.risk_level|default('low') == 'high' else ('warning' if results.risk_level|default('low') == 'medium' else 'success') }} text-{{ 'dark' if results.risk_level|default('low') == 'medium' else 'white' }}">
        <h6 class="mb-0"><i class="bi bi-shield-exclamation"></i> Risk Assessment</h6>
    </div>
    <div class="card-body text-center">
        <h2 class="text-{{ 'danger' if results.risk_level|default('low') == 'high' else ('warning' if results.risk_level|default('low') == 'medium' else 'success') }}">
            {{ results.risk_level|default('Low')|upper }} RISK
        </h2>
        <p>{{ results.risk_summary|default('No significant SIM swap indicators detected.') }}</p>
        <div class="row mt-3">
            <div class="col-md-4">
                <h4>{{ results.swap_events|default([])|length }}</h4>
                <small>SIM Swap Events</small>
            </div>
            <div class="col-md-4">
                <h4>{{ results.suspicious_events|default(0) }}</h4>
                <small>Suspicious Events</small>
            </div>
            <div class="col-md-4">
                <h4>{{ results.correlation_matches|default(0) }}</h4>
                <small>Correlation Matches</small>
            </div>
        </div>
    </div>
</div>

<!-- Correlation Alerts -->
{% if results.alerts %}
<div class="card shadow mb-4">
    <div class="card-header bg-danger text-white">
        <h6 class="mb-0"><i class="bi bi-exclamation-octagon"></i> Correlation Alerts</h6>
    </div>
    <div class="card-body">
        {% for alert in results.alerts %}
        <div class="alert alert-{{ alert.severity|default('warning') }} d-flex align-items-center">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <div>
                <strong>{{ alert.title }}</strong><br>
                <small>{{ alert.description }}</small>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- SIM Swap Events Timeline -->
<div class="card shadow mb-4">
    <div class="card-header bg-danger text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-clock-history"></i> SIM Swap Events Timeline</h6>
            <a href="{{ url_for('sim_swap.view_timeline', case_id=investigation.case_id) }}" class="btn btn-light btn-sm"><i class="bi bi-arrows-fullscreen"></i> Full Timeline</a>
        </div>
    </div>
    <div class="card-body">
        {% if results.swap_events %}
        <div class="timeline">
            {% for event in results.swap_events %}
            <div class="d-flex mb-4">
                <div class="flex-shrink-0 text-center" style="width:80px;">
                    <div class="bg-{{ 'danger' if event.suspicious else 'primary' }} text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                        <i class="bi bi-sim"></i>
                    </div>
                    <small class="d-block text-muted mt-1">{{ event.date }}</small>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="card {{ 'border-danger' if event.suspicious else '' }}">
                        <div class="card-body py-2">
                            <h6 class="mb-1">{{ event.type|default('SIM Change') }}
                                {% if event.suspicious %}
                                <span class="badge bg-danger">Suspicious</span>
                                {% endif %}
                            </h6>
                            <p class="mb-1 small">{{ event.description }}</p>
                            <small class="text-muted">IMSI: {{ event.imsi|default('N/A') }} | ICCID: {{ event.iccid|default('N/A') }}</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">No SIM swap events detected.</p>
        {% endif %}
    </div>
</div>

<!-- Evidence Hash -->
<div class="card shadow mb-4">
    <div class="card-header"><h6 class="mb-0"><i class="bi bi-file-lock"></i> Evidence Integrity</h6></div>
    <div class="card-body">
        <pre class="bg-light p-2 rounded"><code>{{ investigation.evidence_hash }}</code></pre>
    </div>
</div>

<!-- Action Buttons -->
<div class="d-flex gap-2">
    <a href="{{ url_for('sim_swap.search') }}" class="btn btn-danger"><i class="bi bi-search"></i> New Detection</a>
    <a href="{{ url_for('sim_swap.view_timeline', case_id=investigation.case_id) }}" class="btn btn-primary"><i class="bi bi-clock-history"></i> Full Timeline</a>
    <a href="{{ url_for('cases.view_case', case_id=investigation.case_id) }}" class="btn btn-outline-secondary"><i class="bi bi-folder"></i> View Case</a>
</div>
{% endblock %}
